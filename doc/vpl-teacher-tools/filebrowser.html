<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="viewport" content="width=device-width, height=device-height, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />

<link rel="stylesheet" href="html-tools.css" />

<title>VPL Tools</title>

<style>
td {
	padding: 0.5ex;
	user-select: none;
}

.content {
	display: inline-block;
	min-width: 20ex;
	min-height: 2em;
	border: dotted black 1px;
	vertical-align: middle;
}
</style>

<script src="../vpl/thymio/thymio.js"></script>
<script src="ns.js"></script>
<script src="util-url.js"></script>
<script src="../client.js"></script>
<script src="filebrowser.js"></script>

<script>

function updateGUI(fileBrowser) {
	function enable(id, enabled) {
		document.getElementById(id).disabled = !enabled;
		document.getElementById(id).style.display = enabled ? "inline" : "none";
	}

	enable("btn-new", fileBrowser.canCreateProgramFile());
	enable("btn-edit-teacher", fileBrowser.canEditTeacherFile());
	enable("btn-rename-teacher", fileBrowser.canRenameTeacherFile());
	enable("btn-duplicate-teacher", fileBrowser.canDuplicateTeacherFile());
	enable("btn-export-teacher", fileBrowser.canExportTeacherFile());
	enable("btn-remove-teacher", fileBrowser.canDeleteTeacherFiles());
	enable("btn-view-st", fileBrowser.canViewStudentFile());
	enable("btn-export-st", fileBrowser.canExportStudentFile());
	enable("btn-remove-st", fileBrowser.canDeleteStudentFiles());
}

function clearTable(id, labels) {
	var table = document.getElementById(id);
	while (table.firstElementChild) {
		table.removeChild(table.firstElementChild);
	}
	if (labels) {
		var tr = document.createElement("tr");
		labels.forEach(function (label) {
			var th = document.createElement("th");
			th.textContent = label;
			tr.appendChild(th);
		});
		table.appendChild(tr);
	}
}

function fillFileTable(fileArray, fileBrowser, forStudents) {
	var tableId = forStudents ? "files-students" : "files-teacher";
	var table = document.getElementById(tableId);
	var renamedFilename = null;
	if (fileArray.length > 0) {
		clearTable(tableId,
			forStudents
				? ["Filename", "Students", "Time", "Size"]
				: ["Filename", "Time", "Size", "Marked", "Default"]);

		fileArray.forEach(function (file) {
			if (!file.renamed) {
				function select(ev) {
					fileBrowser.selectFile(forStudents, file.id,
						ev.ctrlKey || ev.metaKey, ev.shiftKey);
					ev.preventDefault();
					fileBrowser.refreshFiles();
				}
				function doubleclick(ev) {
					if (!(ev.ctrlKey || ev.metaKey || ev.shiftKey)) {
						fileBrowser.selectFile(forStudents, file.id, false, false);
						ev.preventDefault();
						fillFileTable(fileArray, fileBrowser, forStudents);
						fileBrowser.openFile(forStudents);
					}
				}
			}

			var tr = document.createElement("tr");

			var td = document.createElement("td");
			if (file.renamed) {
				renamedFilename = document.createElement("input");
				renamedFilename.value = file.filename;
				renamedFilename.addEventListener("change", function () {
					fileBrowser.renameTeacherFile(renamedFilename.value);
				});
				renamedFilename.addEventListener("keydown", function (ev) {
					if (ev.key === "Escape") {
						file.renamed = false;
						fillFileTable(fileArray, fileBrowser, forStudents);
					}
				}, false);
				td.appendChild(renamedFilename);
			} else {
				td.textContent = file.filename;
			}
			td.addEventListener("click", select, false);
			td.addEventListener("dblclick", doubleclick, false);
			td.className = fileBrowser.isFileSelected(forStudents, file.id) ? "selected" : "";
			tr.appendChild(td);

			if (forStudents) {
				td = document.createElement("td");
				td.textContent = file.students.join(", ");
				td.addEventListener("click", select, false);
				td.addEventListener("dblclick", doubleclick, false);
				td.className = fileBrowser.isFileSelected(forStudents, file.id) ? "selected" : "";
				tr.appendChild(td);
			}

			td = document.createElement("td");
			td.textContent = file.time || "";
			td.addEventListener("click", select, false);
			td.addEventListener("dblclick", doubleclick, false);
			td.className = fileBrowser.isFileSelected(forStudents, file.id) ? "selected" : "";
			tr.appendChild(td);

			td = document.createElement("td");
			td.textContent = file.size != null ? file.size.toString(10) : "";
			td.addEventListener("click", select, false);
			td.addEventListener("dblclick", doubleclick, false);
			td.className = fileBrowser.isFileSelected(forStudents, file.id) ? "selected" : "";
			tr.appendChild(td);

			if (!forStudents) {
				var isVPL3 = /\.vpl3$/.test(file.filename);
				td = document.createElement("td");
				if (isVPL3) {
					td.textContent = file.mark ? "\u2612" : "\u2610";
					td.addEventListener("click", function () {
						fileBrowser.toggleMark(file.id);
					}, false);
				}
				tr.appendChild(td);
				td = document.createElement("td");
				if (isVPL3) {
					td.textContent = file["default"] ? "\u2612" : "\u2610";
					td.addEventListener("click", function () {
						fileBrowser.setDefaultFile(file.id);
					}, false);
				}
				tr.appendChild(td);
			}

			table.appendChild(tr);
		});
	} else {
		clearTable(tableId);
		var tr = document.createElement("tr");
		var td = document.createElement("td");
		td.setAttribute("class", "empty");
		td.textContent = "(none)";
		tr.appendChild(td);
		table.appendChild(tr);
	}

	updateGUI(fileBrowser);
	if (renamedFilename) {
		var str = renamedFilename.value;
		var r = /^(.*)\.([^.]*)$/.exec(str);
		var basename = r ? r[1] : str;
		renamedFilename.focus();
		renamedFilename.setSelectionRange(0, basename.length);
	}
}

window.addEventListener("load", function () {
	var url0 = "/vpl/vpl.html?ui=ui/classic/ui.json&uilanguage=$LANGUAGE&server=ws://" + document.location.hostname + ":8001/";
	var fileBrowser = new VPLTeacherTools.FileBrowser({
		onTeacherFiles: function (fileArray, fileBrowser) {
    		fillFileTable(fileArray, fileBrowser, false);
			updateGUI(fileBrowser);
		},
		onStudentFiles: function (fileArray, fileBrowser) {
    		fillFileTable(fileArray, fileBrowser, true);
			updateGUI(fileBrowser);
		},
		onOpen: function (file, readOnly) {
			var teacherFile = !file.owner || file.owner.length == 0;
			var options = {
				"initialFileName": file.filename,
				"fileId": teacherFile ? file.id : null,
				"readOnly": readOnly,
				"customizationMode": /\.vpl3ui/.test(file.filename)
			};
            sessionStorage.setItem("options", JSON.stringify(options));
            sessionStorage.setItem("initialFileContent", file.content);
			document.location = "vpl.html?robot=sim" + (teacherFile ? "&role=teacher" : "");
		}
	});

	function importFile(file) {
		var reader = new window.FileReader();
		reader.addEventListener("load", function (event) {
			fileBrowser.addFile(file.name,
				event.target.result);
		});
		reader["readAsText"](file);
	}

	document.body.addEventListener("dragover", function (ev) {
		ev.preventDefault();
	}, false);
	document.body.addEventListener("drop", function (ev) {
		ev.stopPropagation();
		ev.preventDefault();
		var files = ev.dataTransfer.files;
		for (var i = 0; i < files.length; i++) {
			importFile(files[i]);
		}
	}, false);

	var btn;

	btn = document.getElementById("btn-new");
	btn.addEventListener("click", function () {
		var filename = fileBrowser.selectedFile().filename
			.replace(/vpl3ui$/, "vpl3");
		fileBrowser.duplicateTeacherFile(filename);
	}, false);

	btn = document.getElementById("btn-new-conf");
	btn.addEventListener("click", function () {
		fileBrowser.addFile("untitled.vpl3ui",
			'{"disabledUI":["vpl:download","vpl:load"]}');
	}, false);

	btn = document.getElementById("btn-edit-teacher");
	btn.addEventListener("click", function () {
		fileBrowser.openFile(false);
	}, false);

	btn = document.getElementById("btn-rename-teacher");
	btn.addEventListener("click", function () {
		fileBrowser.renameTeacherFile(null);
	}, false);

	btn = document.getElementById("btn-duplicate-teacher");
	btn.addEventListener("click", function () {
		fileBrowser.duplicateTeacherFile(null);
	}, false);

	btn = document.getElementById("btn-export-teacher");
	btn.addEventListener("click", function () {
		fileBrowser.exportFile();
	}, false);

	btn = document.getElementById("btn-remove-teacher");
	btn.addEventListener("click", function () {
		fileBrowser.deleteFiles();
	}, false);

	var chkFilterTeacherLast = document.getElementById("chk-filter-teacher-last");
	chkFilterTeacherLast.addEventListener("change", function () {
		fileBrowser.filterTeacherLast = chkFilterTeacherLast.checked;
		fileBrowser.updateFiles();
	}, false);

	var btn = document.getElementById("btn-view-st");
	btn.addEventListener("click", function () {
		fileBrowser.openFile(true);
	}, false);

	btn = document.getElementById("btn-export-st");
	btn.addEventListener("click", function () {
		fileBrowser.exportFile();
	}, false);

	btn = document.getElementById("btn-remove-st");
	btn.addEventListener("click", function () {
		fileBrowser.deleteFiles();
	}, false);

	var vFilterStudent = document.getElementById("v-filter-student");
	vFilterStudent.addEventListener("input", function () {
		fileBrowser.filterStudent = vFilterStudent.value;
		fileBrowser.updateFiles();
	}, false);

	var chkFilterStLast = document.getElementById("chk-filter-students-last");
	chkFilterStLast.addEventListener("change", function () {
		fileBrowser.filterStudentLast = chkFilterStLast.checked;
		fileBrowser.updateFiles();
	}, false);
}, false);

</script>

</head>

<body>

<nav>
<ul>
<li><a href="students.html">Pupils</a></li>
<li><a class="current" href="filebrowser.html">Files</a></li>
<li><a class="disabled" href="#">VPL</a></li>
<li><a href="pairing.html">Classroom setup</a></li>
<li><a href="dashboard.html">Dashboard</a></li>
<li><a href="doc.html">Documentation</a></li>
<li><span class="space"></span></li>
<li><a href="initdb-dev.html">Test data</a></li>
<li><a href="dev.html">Development doc</a></li>
</ul>
</nav>

<main>

<div class="border">

	<h2>Teacher files</h2>

	<p>
	<label><input id="chk-filter-teacher-last" type="checkbox" checked> most recent version only</label>
	</p>

	<table id="files-teacher">
	</table>

	<p>
	<button id="btn-new">New program</button>
	<button id="btn-new-conf">New config</button>
	<button id="btn-edit-teacher" disabled="true">Edit</button>
	<button id="btn-rename-teacher" disabled="true">Rename</button>
	<button id="btn-duplicate-teacher" disabled="true">Duplicate</button>
	<button id="btn-export-teacher" disabled="true">Export</button>
	<button id="btn-remove-teacher" disabled="true">Delete</button>
	</p>

</div>

<div class="border">

	<h2>Pupil files</h2>

	<p>
	<label>Pupil <input id="v-filter-student"></input></label>
	&nbsp;&nbsp;
	<label><input id="chk-filter-students-last" type="checkbox" checked> most recent version only</label>
	</p>

	<table id="files-students">
	</table>

	<p>
	<button id="btn-view-st" disabled="true">View</button>
	<button id="btn-export-st" disabled="true">Export</button>
	<button id="btn-remove-st" disabled="true">Delete</button>
	</p>

</div>

</main>

</body>

</html>
