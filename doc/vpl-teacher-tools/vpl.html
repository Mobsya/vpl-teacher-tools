<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="viewport" content="width=device-width, height=device-height, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />

<link rel="stylesheet" href="html-tools.css" />

<style>

body {
	margin-bottom: 0;
}

#input {
	position: absolute;
	z-index: 1000;
	font-family: sans-serif;
	font-size: 15pt;
	top: 10px;
	left: 10px;
	display: none;
}

#programCanvas {
	width: 100%;
	heigh: 100%;
}

</style>

<title>VPL Tools</title>

<script src="../vpl/vpl-min.js"></script>
<script src="../vpl/thymio/thymio.js"></script>
<script src="ns.js"></script>
<script src="../client.js"></script>

<script>

window["vplStorageGetFunction"] = function (filename, fun) {

	var progJSON = sessionStorage.getItem("initialFileContent");
	var options = JSON.parse(sessionStorage.getItem("options") || "{}");
	filename = options && options["initialFileName"] || filename;
	var readOnly = options ? options["readOnly"] === true : false;
	var customizationMode = options ? options["customizationMode"] === true : false;
	if (progJSON) {
		// change toolbars
		var prog = JSON.parse(progJSON);
		// disable some buttons in addition to the ones specified in program
		prog["disabledUI"] = [
			"src:language",
			"vpl:new",
			"vpl:load",
			"vpl:text"
		].reduce(function (acc, val) {
			return acc.indexOf(val) < 0 ? acc.concat(val) : acc;
		}, prog["disabledUI"] || []);
		progJSON = JSON.stringify(prog);

		fun(progJSON,
			{
				"filename": filename,
				"readOnly": readOnly,
				"customizationMode": customizationMode
			});
		sessionStorage.setItem("initialUISettings", window["vplGetUIAsJSON"]());
	}
};

window.addEventListener("beforeunload", function () {
	var options = JSON.parse(sessionStorage.getItem("options") || "{}");
	var readOnly = options ? options["readOnly"] === true : false;
	var customizationMode = options ? options["customizationMode"] === true : false;
	var fileId = options ? options["fileId"] : null;
	if (!readOnly && fileId !== null &&
		(window["vplIsProgramChanged"]() ||
			window["vplGetUIAsJSON"]() !== sessionStorage.getItem("initialUISettings"))) {
		var json = window["vplGetProgramAsJSON"](customizationMode);
		console.info(json);
		var client = new VPLTeacherTools.HTTPClient();
		client.updateFile(fileId, json, {asBeacon: true});
	}
}, false);

</script>

</head>

<body>

<nav>
<ul>
<li><a href="students.html">Pupils</a></li>
<li><a href="filebrowser.html">Files</a></li>
<li><a class="current" href="vpl.html">VPL</a></li>
<li><a href="pairing.html">Classroom setup</a></li>
<li><a href="dashboard.html">Dashboard</a></li>
<li><span class="space"></span></li>
<li><a href="initdb-dev.html">Test data</a></li>
<li><a href="doc.html">Documentation</a></li>
</ul>
</nav>

<main>

	<div id="vpl-editor">

	<canvas id="programCanvas" width="900" height="700"></canvas>

	<input id="input">

	</div>

	<div id="src-editor">
	<!-- <pre id="editor-lines"></pre> -->
	<textarea id="editor" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
	</textarea>
	</div>

</main>

</body>

</html>
